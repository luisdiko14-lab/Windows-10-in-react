name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-pages
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: |
          if [ -f package.json ]; then
            HAS_BUILD=$(node -e "const p=require('./package.json'); console.log(!!(p.scripts && p.scripts.build))")
            if [ "$HAS_BUILD" = "true" ]; then
              npm ci
              npm run build
            fi
          fi

      - run: |
          rm -rf _site
          mkdir _site

          if [ -d build ]; then
            cp -r build/* _site/
          elif [ -d dist ]; then
            cp -r dist/* _site/
          elif [ -d public ]; then
            cp -r public/* _site/
          else
            rsync -av --exclude=.git --exclude=.github --exclude=node_modules ./ _site/
          fi

          if [ ! -f _site/index.html ]; then
            echo "<!doctype html><html><body><h1>Index missing</h1></body></html>" > _site/index.html
          fi

          if [ ! -f _site/LICENSE ]; then
            echo "Custom Open License (c) 2025 Luisdiko14-lab, koen-mods" > _site/LICENSE
          fi

          if [ ! -f _site/CREDITS.md ]; then
            echo "Credits: Luisdiko14-lab, koen-mods" > _site/CREDITS.md
          fi

      - uses: actions/configure-pages@v5

      - uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - uses: actions/deploy-pages@v4
